<div class="container py-4">
    <h1>Dashboard</h1>
    {{#if isInstructor}}
        <h1>Instructor Dashboard</h1>
        <p>Username: {{ user.username }}</p>
        <p>Email: {{ user.email }} </p>
        <p>Name: {{ user.firstName }} {{ user.lastName }}</p>
        <p>Role: {{ user.role }}</p>
        <p>Courses:</p>
        {{#each user.courses}}
            <div class="my-2 p-2 border bg-light rounded shadow">
                <p class="lead">{{this.name}}</p>
                <p>{{this.description}}</p>
                <a class="update-course btn btn-warning" href="/courses/{{this._id}}?updating=true">Update Course</a>
                <button class="btn btn-danger delete-course" data-doc="{{this._id}}">Delete Course</button>
            </div>
        {{/each}}
    {{else}}
        <h1>Student Dashboard</h1>
        <p>Username: {{ user.username }}</p>
        <p>Email: {{ user.email }} </p>
        <p>Name: {{ user.firstName }} {{ user.lastName }}</p>
        <p>Role: {{ user.role }}</p>
        <p>Courses: </p>
        {{#each user.courses}}
            <div class="my-2 p-2 border bg-light rounded shadow">
                <p class="lead">{{this.name}}</p>
                <p>{{this.description}}</p>
                <button class="btn btn-danger drop-course" data-doc="{{this._id}}">Drop Course</button>
            </div>
        {{/each}}
    {{/if}}
</div>

<script>

const courseAction = async (courseId, action) => {
    console.log('Course id: ', courseId, ' action: ', action)
    let success = false,
        url = `/courses?courseId=${courseId}`
    const options = {
        method: 'DELETE'
    }
    if(action === 'drop') {
        options.method = 'POST'
        options.body = JSON.stringify({ courseId })
        url = '/user-courses'
    }
    console.log('Options: ', JSON.stringify(options))
    try {
        const response = await fetch(url, options)
        console.log('Data: ', response)
        success = response.status == 200
    } catch (err) {
        console.error(err)
    }
    return success
}

document.querySelectorAll('.delete-course').forEach(btn => {
    btn.addEventListener('click', async (e) => {
        console.log('Deleting course: ', btn.dataset.doc)
        e.preventDefault()
        console.log('Deleting course: ', btn.dataset.doc)
        const success = await courseAction(btn.dataset.doc, 'delete')
        console.log('Success: ', success)
        window.location.reload()
    })
})

document.querySelectorAll('.drop-course').forEach(btn => {
    btn.addEventListener('click', async (e) => {
        e.preventDefault()
        console.log('Dropping course: ', btn.dataset.doc)
        const success = await courseAction(btn.dataset.doc, 'drop')
        console.log('Success: ', success)
        window.location.reload()
    })
})
</script>